{% extends "page.html.twig" %}

{% macro renderOptions(options, curVal) %}
    <option></option>
    {% for option in options %}
        {% set selected = option.name is same as(curVal) ? " selected" : "" %}
        <option value="{{ option.id }}"{{ selected }}>{{ option.name }}</option>
        {% set selected = "" %}
    {% endfor %}
{% endmacro %}

{% import _self as form %}

{# TODO: can this template extend def.html.twig? #}
{% block pageHeader %}
    {% set color = (data.status | lower) is same as('closed') ? ' bg-green' : ' bg-red' %}
    <header class='container page-header'>
        <h1 class='page-title text-white{{ color }}'>{{ pageHeading }}</h1>
        {% if data.closureRequested %}
        <h2>{{ data.closureRequested or '' }}</h2>
        {% endif %}
        {% if session.errorMsg %}
        <h1 class='bg-yellow thin-grey-border'>{{ session.errorMsg }}</h1>
        {% endif %}
    </header>
{% endblock %}

{% block content %}
<form name="defForm" action='updateDefCommit.php' method='POST' enctype='multipart/form-data' onsubmit='' class='item-margin-bottom'>
    <input type='hidden' name='defID' value='{{ data.ID }}'>
    <h4 class='pad grey-bg'>Required Information</h4>
    <div class='row item-margin-bottom'>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='safetyCert' class='required'>Safety Certifiable</label></div>
                <div class='col-md-6'>
                    <select name='safetyCert' id='safetyCert' class='form-control' required>
                        {{ form.renderOptions(options.safetyCert, data.safetyCert) }}
                    </select>
                </div>
            </div>
        </div>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='systemAffected' class='required'>System Affected</label></div>
                <div class='col-md-6'>
                    <select name='systemAffected' id='systemAffected' class='form-control' required>
                        {{ form.renderOptions(options.systemAffected, data.systemAffected) }}
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class='row item-margin-bottom'>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='location' class='required'>General Location</label></div>
                <div class='col-md-6'>
                    <select name='location' id='location' class='form-control' required>
                        {{ form.renderOptions(options.location, data.location) }}
                    </select>
                </div>
            </div>
        </div>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='specLoc' class='required'>Specific Location</label></div>
                <div class='col-md-6'><input type='text' name='specLoc' id='specLoc' value='{{ data.specLoc }}' class='form-control' required></div>
            </div>
        </div>
    </div>
    <div class='row item-margin-bottom'>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='status' class='required'>Status</label></div>
                <div class='col-md-6'>
                    <select name='status' id='status' onchange='return onSelectStatusClosed(event)' class='form-control' required>
                        {{ form.renderOptions(options.status, data.status) }}
                    </select>
                </div>
            </div>
        </div>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='severity' class='required'>Severity</label></div>
                <div class='col-md-6'>
                    <select name='severity' id='severity' class='form-control' required>
                        {{ form.renderOptions(options.severity, data.severity) }}
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class='row item-margin-bottom'>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='dueDate' class='required'>To be resolved by</label></div>
                <div class='col-md-6'><input type='date' name='dueDate' id='dueDate' value='{{ data.dueDate }}' class='form-control' required></div>
            </div>
        </div>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='groupToResolve' class='required'>Group to Resolve</label></div>
                <div class='col-md-6'>
                    <select name='groupToResolve' id='groupToResolve' class='form-control' required>
                        {{ form.renderOptions(options.groupToResolve, data.groupToResolve) }}
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class='row item-margin-bottom'>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='requiredBy' class='required'>Required by</label></div>
                <div class='col-md-6'>
                    <select name='requiredBy' id='requiredBy' class='form-control' required>
                        {{ form.renderOptions(options.requiredBy, data.requiredBy) }}
                    </select>
                </div>
            </div>
        </div>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='contractID' class='required'>Contract</label></div>
                <div class='col-md-6'>
                    <select name='contractID' id='contractID' class='form-control' required>
                        {{ form.renderOptions(options.contract, data.contract) }}
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class='row item-margin-bottom'>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='identifiedBy' class='required'>Identified By</label></div>
                <div class='col-md-6'><input type='text' name='identifiedBy' id='identifiedBy' class='form-control' value='{{ data.identifiedBy }}' required></div>
            </div>
        </div>
        <div class='col-md-6'>
            <div class='row item-margin-bottom'>
                <div class='col-md-6'><label for='defType' class='required'>Deficiency type</label></div>
                <div class='col-md-6'>
                    <select name='defType' id='defType' class='form-control' required>
                        {{ form.renderOptions(options.defType, data.defType) }}
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class='row item-margin-bottom'>
        <div class='col-md-6 offset-md-3'>
            <label for='description' class='required'>Deficiency description</label>
            <textarea name='description' id='description' class='form-control' maxlength='1000' required>{{ data.description }}</textarea>
        </div>
    </div>
    <h5 class='grey-bg pad'>
        <a data-toggle='collapse' href='#optionalInfo' role='button' aria-expanded='false' aria-controls='optionalInfo' class='collapsed'>Optional Information<i class='typcn typcn-arrow-sorted-down'></i></a>
    </h5>
    <div id='optionalInfo' class='collapse item-margin-bottom'>
        <div class='row item-margin-bottom'>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='spec'>Spec or Code</label></div>
                    <div class='col-md-6'><input type='text' name='spec' id='spec' value='{{ data.spec }}' class='form-control'></div>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='actionOwner'>Action Owner</label></div>
                    <div class='col-md-6'><input type='text' name='actionOwner' id='actionOwner' value='{{ data.actionOwner }}' class='form-control'></div>
                </div>
            </div>
        </div>
        <div class='row item-margin-bottom'>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='oldID'>Old Id</label></div>
                    <div class='col-md-6'><input type='text' name='oldID' id='oldID' value='{{ data.oldID }}' class='form-control'></div>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='CDL_pics'>Upload Photo</label></div>
                    <div class='col-md-6'>
                        <input type='file' accept='image/*' name='CDL_pics' id='CDL_pics' class='form-control form-control-file'>
                        <p class="mb-2 text-red">Max. upload size is 4MB</p>
                    </div>
                </div>
            </div>
        </div>
        <p class='text-center pad-less bg-yellow'>Photos uploaded from your phone may not preserve rotation information. We are working on a fix for this.</p>
    </div>
    <h5 class='grey-bg pad'>
        <a data-toggle='collapse' href='#closureInfo' role='button' aria-expanded='false' aria-controls='closureInfo' class='collapsed'>Closure Information<i class='typcn typcn-arrow-sorted-down'></i></a>
    </h5>
    <div id='closureInfo' class='collapse item-margin-bottom'>
        <div class='row item-margin-bottom'>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='evidenceType'>Evidence Type</label></div>
                    <div class='col-md-6'>
                        <select name='evidenceType' id='evidenceType' class='form-control'>
                            {{ form.renderOptions(options.evidenceType, data.evidenceType) }}
                        </select>
                    </div>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='repo'>Document Repository</label></div>
                    <div class='col-md-6'>
                        <select name='repo' id='repo' class='form-control'>
                            {{ form.renderOptions(options.repo, data.repo) }}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class='row item-margin-bottom'>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='evidenceID'>Document Number</label></div>
                    <div class='col-md-6'><input type='text' name='evidenceID' id='evidenceID' class='form-control' value='{{ data.evidenceID }}'></div>
                </div>
            </div>
            <div class='col-md-6'>
                <div class='row item-margin-bottom'>
                    <div class='col-md-6'><label for='evidenceLink'>Document Link</label></div>
                    <div class='col-md-6'><input type='text' name='evidenceLink' id='evidenceLink' class='form-control' value='{{ data.evidenceLink }}'></div>
                </div>
            </div>
        </div>
        <div class='row item-margin-bottom'>
            <div class='col-md-6 offset-md-3'>
                <label for='closureComments'>Closure Comments</label>
                <textarea name='closureComments' id='closureComments' class='form-control' maxlength='1000'>{{ data.closureComments }}</textarea>
            </div>
        </div>
    </div>
    <h5 class='grey-bg pad'>
        <a data-toggle='collapse' href='#comments' role='button' aria-expanded='false' aria-controls='comments' class='collapsed'>Comments<i class='typcn typcn-arrow-sorted-down'></i></a>
    </h5>
    <div id='comments' class='collapse item-margin-bottom'>
        <div class='row mb-3'>
            <div class='col-sm-8 offset-sm-2 thin-grey-border pad'>
                <label for='cdlCommText'>Add comment</label>
                <textarea name='cdlCommText' id='cdlCommText' class='form-control' maxlength='1000'></textarea>
            </div>
        </div>
        {% for comment in data.comments %}
        <div class='row mb-3'>
            <div class="col-sm-8 offset-sm-2 thin-grey-border pad">
                <h6 class='d-flex flex-row justify-content-between text-secondary'><span>{{ comment.userFullName }}</span><span>{{ comment.date_created | date('n-j-Y • G:i') }}</span></h6>
                <p>{{ comment.commentText | html_sanitize_decode | unescape | raw }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    <h5 class='grey-bg pad'>
        <a data-toggle='collapse' href='#modHistory' role='button' aria-expanded='' aria-controls='modHistory' class='collapsed'>Modification History<i class='typcn typcn-arrow-sorted-down'></i></a>
    </h5>
    <section id='modHistory' class='collapse'>
        <div class='row item-margin-bottom'>
            <div class='col-md-3'><p>Date Created</p></div><div class='col-md-3'><p>{{ data.dateCreated | date("n-j-Y") }}</p></div>
            <div class='col-md-3'><p>Created by</p></div><div class='col-md-3'><p>{{ data.created_by }}</p></div>
        </div>
        <div class='row item-margin-bottom'>
            <div class='col-md-3'><p>Last Updated</p></div><div class='col-md-3'><p>{{ data.lastUpdated | date("n-j-Y G:i")}}</p></div>
            <div class='col-md-3'><p>Updated by</p></div><div class='col-md-3'><p>{{ data.updated_by }}</p></div>
        </div>
    </section>
    {% if not data.photos is empty %}
    <h5 class='grey-bg pad'>
        <a data-toggle='collapse' href='#defPics' role='button' aria-expanded='' aria-controls='defPics' class='collapsed'>Photos<i class='typcn typcn-arrow-sorted-down'></i></a>
    </h5>
    <section id='defPics' class='collapse item-margin-bottom'>
        {% for row in data.photos %}
        <div class='row item-margin-bottom'>
            {% for photo in row %}
            <div class='col-md-4'><img src='{{ photo.filepath }}' alt='photo related to deficiency number {{ data.ID }}'></div>
            {% endfor %}
        </div>
        {% endfor %}
    </section>
    {% endif %}
    <div class='item-margin-bottom center-content'>
        {% if (data.status | lower) is same as('closed') %}
            <button type='button' class='btn btn-lg btn-primary' onclick='return reopenDef(event)'>Re-open Deficiency</button>
        {% else %}
            <button type='submit' class='btn btn-primary btn-lg'>Submit</button>
            <button type='reset' class='btn btn-primary btn-lg'>Reset</button>
        {% endif %}
    </div>
</form>
{% if session.role >= 40 %}
<form action='DeleteDef.php' method='POST' onsubmit=''>
    <div class='row'>
        <div class='col-12 center-content'>
            <button class='btn btn-danger btn-lg' type='submit' name='q' value='{{ data.ID }}'
                onclick='return confirm("ARE YOU SURE? Deficiencies should not be deleted, your deletion will be logged.")'>delete</button>
        </div>
    </div>
</form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    function onSelectStatusClosed(ev) {
        const form = document.forms['defForm']
        const selectedStatus = form['status'].selectedOptions[0].innerText.toLowerCase()
        const requiredFields = [ 'repo', 'evidenceType', 'evidenceID' ]

        if (selectedStatus === 'closed') {
            requiredFields.forEach(field => {
                document.querySelector(`label[for="${field}"]`).classList.add('required')
                form[field].setAttribute('required', '')
                $('#closureInfo').collapse('show')
            })
        }

        if (selectedStatus === 'open') {
            requiredFields.forEach(field => {
                document.querySelector(`label[for="${field}"]`).classList.remove('required')
                form[field].removeAttribute('required')
            })
        }
    }

    function reopenDef(ev) { // TODO: do we want a window.confirm here?
        const form = document.forms['defForm']
        form.status.value = 1
        form.submit()
    }
</script>
{% endblock %}